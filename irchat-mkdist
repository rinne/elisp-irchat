#! /bin/sh
#
# $Id: irchat-mkdist,v 1.11 2001/06/07 14:25:09 tri Exp $
#
# This file is part of irchat.  Command irchat-mkdist creates 
# a snapshot of irchat current.  This file itself does not go 
# into the snapshot archive.
#
# Author: Timo J. Rinne <tri@iki.fi>
#
# This file is covered by the copyright notice in irchat-copyright.el.
#

distfiles=""

if [ "x$1" != "x" ] ; then
    distname="irchat-""$1"
else
    distname="irchat-`date -u '+%Y%m%d'`"
fi

[ -d "$distname" ] && { echo "You have already made $distname today."; exit 1; }

mkdir "$distname"
[ $? -ne 0 ] &&  { echo "Unable to make distdir $distname."; exit 1; }

( date -u '+%a %b %d %H:%M:%S  IRCHAT Distribution Generator <irchat@rinne.iki.fi>' ;
  echo '' ;
  echo '	* Generated release '"$distname"'.' ;
  echo '' ;
  cat ChangeLog ) > ChangeLog.new

for i in * ; do
    if [ -f "$i" ] ; then
        if [ "$i" = "irchat-mkdist" ] ; then
            echo 'Skipped irchat-mkdist.'
        elif [ "$i" = "ChangeLog" ] ; then
            echo 'Skipped ChangeLog.'
        elif [ "$i" = "ChangeLog.new" ] ; then
            cp -p ChangeLog.new "$distname"/ChangeLog
            rm -f ChangeLog.new
        else
            cp -p "$i" "$distname"
            [ $? -ne 0 ] &&  { echo "Unable to copy file $i."; exit 1; }
            distfiles="$distfiles $i"
        fi
    fi
done

rm -f "$distname"/*.elc

( cd "$distname" &&
  ttt="/tmp/xxx.$$"
  rm -f "$ttt"
  for i in ./* ; do
     cat "$i" |
     gawk 'BEGIN { s = 1; }
                 { if      (match($0, "^... BEGIN NODIST")) { s = 0 }
                   else if (match($0, "^... END NODIST"))   { s = 1 }
                   else if (s == 1) { print $0 } }' |
     sed 's,\$Date[^$]*\$,'"`date -u '+$Date: 2001/06/07 14:25:09 $'`"',' > "$ttt" &&
     rm -f "$i" &&
     cat "$ttt" > "$i" &&
     rm -f "$ttt"
  done
  true ) &&
chmod 755 "$distname" &&
( cd "$distname" &&
  gmake xemacs-compact &&
  mv irchat.elc irchat-xemacs-elc &&
  gmake gnuemacs-compact &&
  mv irchat.elc irchat-gnuemacs-elc &&
  mv irchat-xemacs-elc irchat-xemacs.elc &&
  mv irchat-gnuemacs-elc irchat-gnuemacs.elc ) &&
chmod a-w,a+r,u+w "$distname"/* &&
tar cvf "$distname"".tar" ./"$distname" &&
gzip -9 "$distname"".tar" &&
ls -l "$distname"".tar.gz" &&
cp -p "$distname"/ChangeLog "$distname"/irchat-version.el . &&
rm -rf "$distname" &&
exit 0

exit 2

# eof (irchat-mkdist)
